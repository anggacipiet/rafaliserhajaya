{{ $image := .Src | default .image }}
{{ $alt := .alt }}
{{ $class := .class }}
{{ $width := .width }}
{{ $height := .height }}

{{ $defaultWidth := 800 }}
{{ $defaultHeight := 600 }}

{{ $imageType := "" }}
{{ if findRE "product/" $image }}
  {{ $defaultWidth = 400 }}
  {{ $defaultHeight = 300 }}
{{ else if findRE "blog/" $image }}
  {{ $defaultWidth = 800 }}
  {{ $defaultHeight = 600 }}
{{ else if findRE "events/" $image }}
  {{ $defaultWidth = 600 }}
  {{ $defaultHeight = 400 }}
{{ else if findRE "about/" $image }}
  {{ $defaultWidth = 800 }}
  {{ $defaultHeight = 600 }}
{{ else if findRE "rafalis" $image }}
  {{ $defaultWidth = 200 }}
  {{ $defaultHeight = 80 }}
{{ end }}

{{ $width = $width | default $defaultWidth }}
{{ $height = $height | default $defaultHeight }}

<picture>
  {{ $imageBase := path.Base $image }}
  {{ $imageExt := path.Ext $image }}
  {{ $imageName := strings.TrimSuffix $imageExt $imageBase }}
  {{ $imageDir := path.Dir $image }}
  {{ $staticPath := printf "static/%s" $image }}
  {{ $imageExists := fileExists $staticPath }}
  
  {{ if $imageExists }}
  <!-- AVIF -->
  <source
    type="image/avif"
    srcset="{{ printf "%s/%s.avif" $imageDir $imageName | absURL }}"
  >
  
  <!-- WebP -->
  <source
    type="image/webp"
    srcset="{{ printf "%s/%s.webp" $imageDir $imageName | absURL }}"
  >
  
  <!-- Fallback -->
  <img
    src="{{ $image | absURL }}"
    alt="{{ $alt }}"
    {{ with $class }}class="{{ . }}"{{ end }}
    loading="lazy"
    width="{{ $width }}"
    height="{{ $height }}"
    style="aspect-ratio: {{ $width }}/{{ $height }};"
  >
  {{ else }}
  <!-- Placeholder for missing image -->
  <img
    src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='{{ $width }}' height='{{ $height }}' viewBox='0 0 {{ $width }} {{ $height }}'%3E%3Crect width='100%25' height='100%25' fill='%23eee'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' font-family='sans-serif' font-size='14' fill='%23999'%3EImage not found%3C/text%3E%3C/svg%3E"
    alt="{{ $alt }} (not found)"
    {{ with $class }}class="{{ . }}"{{ end }}
    width="{{ $width }}"
    height="{{ $height }}"
    style="aspect-ratio: {{ $width }}/{{ $height }};"
  >
  {{ end }}
</picture>