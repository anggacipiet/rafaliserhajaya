{{ $image := .Src | default .image }}
{{ $alt := .Alt | default .alt | default "" }}
{{ $class := .Class | default .class | default "img-fluid" }}
{{ $style := .Style | default .style }}

{{/* Define image dimensions map */}}
{{ $dimensions := dict 
  "product" (dict "width" 800 "height" 600 "quality" 80)
  "blog" (dict "width" 800 "height" 600 "quality" 80)
  "events" (dict "width" 600 "height" 400 "quality" 80)
  "about" (dict "width" 800 "height" 600 "quality" 80)
  "banner" (dict "width" 1200 "height" 400 "quality" 75)
  "logo" (dict "width" 200 "height" 80 "quality" 90)
}}

{{/* Process Image */}}
{{ $processedImage := "" }}
{{ if fileExists (printf "static/%s" $image) }}
  {{ $original := resources.Get $image }}
  {{ with $original }}
    {{ $processedImage = . }}
    
    {{/* Resize based on type */}}
    {{ $imageType := "" }}
    {{ if findRE "product/" $image }}
      {{ $imageType = "product" }}
    {{ else if findRE "blog/" $image }}
      {{ $imageType = "blog" }}
    {{ else if findRE "events/" $image }}
      {{ $imageType = "events" }}
    {{ else if findRE "about/" $image }}
      {{ $imageType = "about" }}
    {{ else if findRE "banner/" $image }}
      {{ $imageType = "banner" }}
    {{ else if findRE "rafalis" $image }}
      {{ $imageType = "logo" }}
    {{ end }}

    {{ with $imageType }}
      {{ with index $dimensions . }}
        {{ $processedImage = $original.Resize (printf "%dx%d q-%d" .width .height .quality) }}
      {{ end }}
    {{ end }}

    {{/* Generate WebP version */}}
    {{ $webp := $processedImage.Resize (printf "%dx%d webp q-%d" $processedImage.Width $processedImage.Height ($processedImage.Quality | default 85)) }}

    <picture>
      <source 
        srcset="{{ $webp.RelPermalink }}"
        type="image/webp"
      >
      <img
        src="{{ $processedImage.RelPermalink }}"
        alt="{{ $alt }}"
        width="{{ $processedImage.Width }}"
        height="{{ $processedImage.Height }}"
        loading="lazy"
        class="{{ $class }}"
        {{ with $style }}style="{{ . }}"{{ end }}
      >
    </picture>
  {{ end }}
{{ end }}