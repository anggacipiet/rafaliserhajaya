{{ $image := "" }}
{{ if hasPrefix .Src "images/" }}
  {{ $image = resources.Get .Src }}
{{ else if hasPrefix .Src "/" }}
  {{ $image = resources.Get (strings.TrimPrefix "/" .Src) }}
{{ end }}

{{ if $image }}
  {{ $imgType := path.Ext .Src }}
  
  {{ $small := $image.Resize "400x webp" }}
  {{ $medium := $image.Resize "800x webp" }}
  {{ $large := $image.Resize "1200x webp" }}

  {{ $smallOriginal := $image.Resize "400x" }}
  {{ $mediumOriginal := $image.Resize "800x" }}
  {{ $largeOriginal := $image.Resize "1200x" }}

  <picture>
    <!-- WebP versions -->
    <source 
      srcset="{{ $large.RelPermalink }}"
      type="image/webp"
      media="(min-width: 1200px)">
    <source 
      srcset="{{ $medium.RelPermalink }}"
      type="image/webp"
      media="(min-width: 800px)">
    <source 
      srcset="{{ $small.RelPermalink }}"
      type="image/webp">
      
    <!-- Original format fallback -->
    <source 
      srcset="{{ $largeOriginal.RelPermalink }}"
      type="image/{{ if eq $imgType ".png" }}png{{ else }}jpeg{{ end }}"
      media="(min-width: 1200px)">
    <source 
      srcset="{{ $mediumOriginal.RelPermalink }}"
      type="image/{{ if eq $imgType ".png" }}png{{ else }}jpeg{{ end }}"
      media="(min-width: 800px)">
    <source 
      srcset="{{ $smallOriginal.RelPermalink }}"
      type="image/{{ if eq $imgType ".png" }}png{{ else }}jpeg{{ end }}">
      
    <img
      src="{{ $smallOriginal.RelPermalink }}"
      alt="{{ .Alt }}"
      class="{{ if .Class }}{{ .Class }}{{ else }}img-fluid{{ end }}"
      loading="lazy"
      width="{{ $small.Width }}"
      height="{{ $small.Height }}">
  </picture>
{{ else }}
  <img 
    src="{{ .Src | relURL }}" 
    alt="{{ .Alt }}" 
    class="{{ if .Class }}{{ .Class }}{{ else }}img-fluid{{ end }}"
    loading="lazy">
{{ end }}