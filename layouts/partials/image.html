{{ $image := .Src | default .image }}
{{ $alt := .Alt | default .alt | default "" }}
{{ $class := .Class | default .class | default "img-fluid" }}
{{ $style := .Style | default .style }}

{{ if $image }}
    {{ if fileExists (printf "static/%s" $image) }}
        {{ $original := resources.Get $image }}
        {{ with $original }}
            {{ $processedImage := . }}
            {{ $dimensions := dict "product" (dict "width" 800 "height" 600) "blog" (dict "width" 800 "height" 600) "events" (dict "width" 600 "height" 400) "about" (dict "width" 800 "height" 600) "banner" (dict "width" 1200 "height" 400) "logo" (dict "width" 200 "height" 80) }}
            
            {{ $imageType := "" }}
            {{ if findRE "product/" $image }}
                {{ $imageType = "product" }}
            {{ else if findRE "blog/" $image }}
                {{ $imageType = "blog" }}
            {{ else if findRE "events/" $image }}
                {{ $imageType = "events" }}
            {{ else if findRE "about/" $image }}
                {{ $imageType = "about" }}
            {{ else if findRE "banner/" $image }}
                {{ $imageType = "banner" }}
            {{ else if findRE "rafalis" $image }}
                {{ $imageType = "logo" }}
            {{ end }}

            {{ $width := 800 }}
            {{ $height := 600 }}
            {{ if $imageType }}
                {{ with index $dimensions $imageType }}
                    {{ $width = .width }}
                    {{ $height = .height }}
                    {{ $processedImage = $original.Resize (printf "%dx%d" .width .height) }}
                {{ end }}
            {{ end }}

            <picture>
                {{ $webp := $processedImage.Resize (printf "%dx%d webp q-85" $width $height) }}
                <source 
                    srcset="{{ $webp.RelPermalink }}" 
                    type="image/webp"
                    width="{{ $width }}"
                    height="{{ $height }}"
                >
                <img 
                    src="{{ $processedImage.RelPermalink }}"
                    alt="{{ $alt }}"
                    width="{{ $width }}"
                    height="{{ $height }}"
                    class="{{ $class }}"
                    {{ with $style }}style="{{ . }}; object-fit: cover;"{{ else }}style="object-fit: cover;"{{ end }}
                    loading="lazy"
                >
            </picture>
        {{ else }}
            <img 
                src="{{ $image | relURL }}"
                alt="{{ $alt }}"
                width="800"
                height="600"
                class="{{ $class }}"
                {{ with $style }}style="{{ . }}; object-fit: cover;"{{ else }}style="object-fit: cover;"{{ end }}
                loading="lazy"
            >
        {{ end }}
    {{ else }}
        <div style="color: red;">
            File not found: {{ $image }}
        </div>
    {{ end }}
{{ else }}
    <div style="color: red;">
        No image source provided
    </div>
{{ end }}